<!doctype html>

<html>
  <head>
    <link rel="stylesheet" href="lib/style.css">
  </head>

  <body>
    <h1>Mime Anonymiser</h1>
    <div>This website has been specifically developed to anonymise ILR data. Please use this website to anonymise your ILR return(s) for the years requested (usually the latest R14 return available), by following the instructions below:
    <ul>
        <li>Click the "Browse" button, then select your ILR XML file from the pop-up window, and click "Open"</li>
        <li>A download link should then appear - please click on this link, then save the XML file that downloads</li>
        <li>Securely send the file to Mime - we normally recommend using Egress (and emailing to <a href="mailto:egress@mimeconsulting.co.uk">egress@mimeconsulting.co.uk</a>), but you may choose to use your own secure email system.</li>
    </ul>
    Please note that you should have already returned your data sharing agreement to Mime before sending the anonymised data.
    </div>
    </br>
    <input id="fileChooser" type="file">
    <a href="#" id="download">Download anonymised file</a>
    </br>
    </br>
    <img src="mime.png" width="100px">
  </body>
    <script>
        var fileChooser = document.getElementById('fileChooser');
        
        function parseTextAsXml(text) {
            var parser = new DOMParser(),
            xmlDom = parser.parseFromString(text, "text/xml");

            learners = xmlDom.getElementsByTagName("Learner")
            for (var i = 0; i < learners.length; i++) {
                learners[i].getElementsByTagName("GivenNames")[0].textContent = 'Anon';
                learners[i].getElementsByTagName("FamilyName")[0].textContent = 'Anon';

                if( learners[i].getElementsByTagName("NINumber").length != 0 )
                {
                    learners[i].getElementsByTagName("NINumber")[0].textContent = 'XX';
                }
                if( learners[i].getElementsByTagName("AddLine1").length != 0 )
                {
                    learners[i].getElementsByTagName("AddLine1")[0].textContent = 'XX';
                }
                if( learners[i].getElementsByTagName("AddLine2").length != 0 )
                {
                    learners[i].getElementsByTagName("AddLine2")[0].textContent = 'XX';
                }
                if( learners[i].getElementsByTagName("AddLine3").length != 0 )
                {
                    learners[i].getElementsByTagName("AddLine3")[0].textContent = 'XX';
                }
                if( learners[i].getElementsByTagName("AddLine4").length != 0 )
                {
                    learners[i].getElementsByTagName("AddLine4")[0].textContent = 'XX';
                }
                if( learners[i].getElementsByTagName("TelNo").length != 0 )
                {
                    learners[i].getElementsByTagName("TelNo")[0].textContent = 'XX';
                }
                if( learners[i].getElementsByTagName("Email").length != 0 )
                {
                    learners[i].getElementsByTagName("Email")[0].textContent = 'XX';
                }
            }

            var serializer = new XMLSerializer();
            var xmlString = serializer.serializeToString(xmlDom);
            var fileName = "anonymised_ilr.xml";
            var fileContent = xmlString;
            var myFile = new Blob([fileContent], {type: 'text/plain'});

            window.URL = window.URL || window.webkitURL;
            var dlBtn = document.getElementById("download");

            dlBtn.setAttribute("href", window.URL.createObjectURL(myFile));
            dlBtn.setAttribute("download", fileName);
        }

        function waitForTextReadComplete(reader) {
            reader.onloadend = function(event) {
                var text = event.target.result;
                parseTextAsXml(text);
            }
        }

        function handleFileSelection() {
            var file = fileChooser.files[0],
            reader = new FileReader();
            waitForTextReadComplete(reader);
            reader.readAsText(file);
        }

        fileChooser.addEventListener('change', handleFileSelection, false);

</script>
</html>
